<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç | LanguaParadise</title>
    <link href="/static/css/minimal.css" rel="stylesheet">
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <a href="/" class="logo">LanguaParadise</a>
                <nav class="nav">
                    <a href="/courses">–ö—É—Ä—Å—ã</a>
                    <a href="/person">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</a>
                    <a href="/korzina">–ö–æ—Ä–∑–∏–Ω–∞</a>
                    <a href="/logout">–í—ã—Ö–æ–¥</a>
                </nav>
            </div>
        </div>
    </header>

    <main>
        <div class="container">
            <h1>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h1>

            <!-- –ë–ª–æ–∫ —Å –ª–∏—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π -->
            <div class="profile-section">
                <div class="card profile-main-card">
                    <div class="profile-header">
                        <div class="profile-avatar">
                            <div class="avatar-placeholder">
                                <span th:if="${user.avatar == null}" th:text="${user.name != null ? user.name.substring(0,1).toUpperCase() : 'U'}">U</span>
                                <img th:if="${user.avatar != null}" th:src="${user.avatar}" alt="–ê–≤–∞—Ç–∞—Ä" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                            </div>
                            <button class="btn btn-secondary btn-small" onclick="changePhoto()">–ò–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ</button>
                            <input type="file" id="photoInput" accept="image/*" style="display: none;" onchange="handlePhotoChange(event)">
                        </div>
                        <div class="profile-details">
                            <div class="profile-field">
                                <label>–ò–º—è:</label>
                                <span th:text="${user.name}">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</span>
                            </div>
                            <div class="profile-field">
                                <label>–§–∞–º–∏–ª–∏—è:</label>
                                <span th:text="${user.surName}">–§–∞–º–∏–ª–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</span>
                            </div>
                            <div class="profile-field">
                                <label>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è:</label>
                                <span th:text="${user.birthDate != null ? #temporals.format(user.birthDate, 'dd.MM.yyyy') : '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}" 
                                      th:class="${user.birthDate != null ? '' : 'text-muted'}">–ù–µ —É–∫–∞–∑–∞–Ω–∞</span>
                            </div>
                            <div class="profile-field">
                                <label>Email:</label>
                                <span th:text="${user.username}">email@example.com</span>
                            </div>
                            <div class="profile-field">
                                <label>–†–æ–ª—å:</label>
                                <span id="userRole" th:text="${user.role != null ? user.role.displayName : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>
                            </div>
                            <div class="profile-field">
                                <label>–ë–∞–ª–∞–Ω—Å:</label>
                                <span id="userBalance" class="balance" th:text="${user.balance != null ? user.balance + ' ‚ÇΩ' : '0 ‚ÇΩ'}">0 ‚ÇΩ</span>
                            </div>
                        </div>
                    </div>
                    <div class="profile-actions">
                        <button class="btn btn-primary" onclick="editProfile()">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
                        <button class="btn btn-secondary" onclick="showBalanceModal()">–ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</button>
                    </div>
                </div>
            </div>

            <!-- –ù–∏–∂–Ω–∏–µ –±–ª–æ–∫–∏: –ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤ –∏ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="profile-bottom-section">
                <!-- –ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤ -->
                <div class="profile-section-half">
                    <h2>–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</h2>
                    
                    <div th:if="${not #lists.isEmpty(orders)}">
                        <div class="orders-list">
                            <div class="order-card" th:each="order : ${orders}">
                                <div class="order-header">
                                    <div class="order-date">
                                        <strong>üìÖ –ó–∞–∫–∞–∑ –æ—Ç </strong>
                                        <span th:text="${order.orderDate}">–î–∞—Ç–∞ –∑–∞–∫–∞–∑–∞</span>
                                    </div>
                                    <div class="order-total">
                                        <strong th:text="${order.totalCost} + '‚ÇΩ'">–°—Ç–æ–∏–º–æ—Å—Ç—å</strong>
                                    </div>
                                </div>
                                
                                <div class="order-courses">
                                    <div class="courses-header">
                                        <strong>üìö –ö—É—Ä—Å—ã –≤ –∑–∞–∫–∞–∑–µ:</strong>
                                    </div>
                                    <div class="courses-grid">
                                        <div class="course-item" th:each="orderItem : ${order.orderItems}">
                                            <div class="course-avatar">
                                                <div th:if="${orderItem.cours.avatar == null}" class="avatar-placeholder">üìñ</div>
                                                <img th:if="${orderItem.cours.avatar != null}" th:src="${orderItem.cours.avatar}" alt="–ö—É—Ä—Å">
                                            </div>
                                            <div class="course-info">
                                                <div class="course-name" th:text="${orderItem.cours.name}">–ù–∞–∑–≤–∞–Ω–∏–µ –∫—É—Ä—Å–∞</div>
                                                <div class="course-price" th:text="${orderItem.cours.coursPrice} + '‚ÇΩ'">–¶–µ–Ω–∞</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div th:if="${#lists.isEmpty(orders)}" class="text-center">
                        <div class="card">
                            <h3>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤</h3>
                            <p class="text-muted mb-3">–ù–∞—á–Ω–∏—Ç–µ –∏–∑—É—á–µ–Ω–∏–µ —è–∑—ã–∫–æ–≤ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å!</p>
                            <a href="/courses" class="btn btn-primary">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫—É—Ä—Å—ã</a>
                        </div>
                    </div>
                </div>

                <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                <div class="profile-section-half">
                    <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
                    <div class="card">
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-number" th:text="${#lists.size(orders)}">0</div>
                                <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number" th:text="${orders != null and !#lists.isEmpty(orders) ? #aggregates.sum(orders.![totalCost]) + '‚ÇΩ' : '0‚ÇΩ'}">0‚ÇΩ</div>
                                <div class="stat-label">–ü–æ—Ç—Ä–∞—á–µ–Ω–æ –≤—Å–µ–≥–æ</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number" th:text="${orders != null and !#lists.isEmpty(orders) ? #aggregates.sum(orders.![#lists.size(orderItems)]) : 0}">0</div>
                                <div class="stat-label">–ö—É—Ä—Å–æ–≤ –∫—É–ø–ª–µ–Ω–æ</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>–û –Ω–∞—Å</h3>
                    <p class="text-muted">
                        LanguaParadise ‚Äî —Ä–∞–∑—Ä—É—à–∞–µ–º —è–∑—ã–∫–æ–≤—ã–µ –±–∞—Ä—å–µ—Ä—ã —Å –∫–æ–º—Ñ–æ—Ä—Ç–æ–º!
                    </p>
                </div>
                <div class="footer-section">
                    <h3>–ù–∞–≤–∏–≥–∞—Ü–∏—è</h3>
                    <ul>
                        <li><a href="/courses">–ö—É—Ä—Å—ã</a></li>
                        <li><a href="/person">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</a></li>
                        <li><a href="/korzina">–ö–æ—Ä–∑–∏–Ω–∞</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>–ö–æ–Ω—Ç–∞–∫—Ç—ã</h3>
                    <ul>
                        <li>–ò–ö–ë–û-36-22</li>
                        <li>–ù–∞–∑–∏—Ä–æ–≤ –§. –§.</li>
                        <li><a href="mailto:nazirov.f.f@gmail.com">nazirov.f.f@gmail.com</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </footer>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è -->
    <div id="editProfileModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</h3>
                <span class="close" onclick="closeModal('editProfileModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="editProfileForm">
                    <div class="form-group">
                        <label class="form-label" for="editName">–ò–º—è</label>
                        <input type="text" id="editName" class="form-input" th:value="${user.name}" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="editSurname">–§–∞–º–∏–ª–∏—è</label>
                        <input type="text" id="editSurname" class="form-input" th:value="${user.surName}" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="editBirthdate">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
                        <input type="date" id="editBirthdate" class="form-input" th:value="${user.birthDate}">
                    </div>
                    <!-- Email –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è -->
                    <div class="form-group">
                        <label class="form-label">Email (–Ω–µ –∏–∑–º–µ–Ω—è–µ—Ç—Å—è)</label>
                        <input type="email" class="form-input" th:value="${user.username}" disabled style="background-color: var(--light-gray); color: var(--text-secondary);">
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn btn-primary" onclick="saveProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('editProfileModal')">–û—Ç–º–µ–Ω–∞</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ -->
    <div id="balanceModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>–ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</h3>
                <span class="close" onclick="closeModal('balanceModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="balanceForm">
                    <div class="form-group">
                        <label class="form-label" for="amount">–°—É–º–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è (‚ÇΩ)</label>
                        <input type="number" id="amount" class="form-input" min="100" max="50000" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="paymentMethod">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</label>
                        <select id="paymentMethod" class="form-input" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</option>
                            <option value="card">–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞</option>
                            <option value="yandex">–Ø–Ω–¥–µ–∫—Å.–î–µ–Ω—å–≥–∏</option>
                            <option value="qiwi">QIWI</option>
                        </select>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn btn-primary" onclick="processPayment()">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('balanceModal')">–û—Ç–º–µ–Ω–∞</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>

        function changePhoto() {
            document.getElementById('photoInput').click();
        }

        function handlePhotoChange(event) {
            const file = event.target.files[0];
            if (file) {

                if (file.size > 5 * 1024 * 1024) {
                    showNotification('–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–≤—ã—à–∞—Ç—å 5MB', 'error');
                    return;
                }


                if (!file.type.startsWith('image/')) {
                    showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ', 'error');
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64String = e.target.result;
                    

                    const avatarPlaceholder = document.querySelector('.avatar-placeholder');
                    avatarPlaceholder.innerHTML = `<img src="${base64String}" alt="–ê–≤–∞—Ç–∞—Ä" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
                    

                    const avatarData = {
                        avatar: base64String
                    };

                    fetch('/api/avatar/update', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(avatarData)
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showNotification('–§–æ—Ç–æ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!', 'success');
                        } else {
                            showNotification(data.message || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–æ—Ç–æ', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
                    });
                };
                reader.readAsDataURL(file);
            }
        }


        function editProfile() {
            document.getElementById('editProfileModal').style.display = 'flex';
        }

        function saveProfile() {
            const name = document.getElementById('editName').value;
            const surname = document.getElementById('editSurname').value;
            const birthdate = document.getElementById('editBirthdate').value;

            if (!name || !surname || !birthdate) {
                showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', 'error');
                return;
            }


            const profileData = {
                name: name,
                surName: surname,
                birthDate: birthdate || null
            };

            fetch('/api/profile/update', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(profileData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {

                    document.querySelector('.profile-field:nth-child(1) span').textContent = name;
                    document.querySelector('.profile-field:nth-child(2) span').textContent = surname;
                    
                    if (birthdate) {
                        const formattedDate = new Date(birthdate).toLocaleDateString('ru-RU');
                        document.querySelector('.profile-field:nth-child(3) span').textContent = formattedDate;
                        document.querySelector('.profile-field:nth-child(3) span').classList.remove('text-muted');
                    }


                    const avatarImg = document.querySelector('.avatar-placeholder img');
                    if (!avatarImg) {
                        document.querySelector('.avatar-placeholder span').textContent = name.charAt(0).toUpperCase();
                    }

                    closeModal('editProfileModal');
                    showNotification('–ü—Ä–æ—Ñ–∏–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!', 'success');
                } else {
                    showNotification(data.message || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
            });
        }


        function showBalanceModal() {
            document.getElementById('balanceModal').style.display = 'flex';
        }

        function processPayment() {
            const amount = document.getElementById('amount').value;
            const paymentMethod = document.getElementById('paymentMethod').value;

            if (!amount || !paymentMethod) {
                showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
                return;
            }

            if (amount < 100) {
                showNotification('–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è: 100 ‚ÇΩ', 'error');
                return;
            }


            const balanceData = {
                amount: parseFloat(amount),
                paymentMethod: paymentMethod
            };

            showNotification('–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–∞...', 'info');

            fetch('/api/balance/update', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(balanceData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {

                    const balanceElement = document.getElementById('userBalance');
                    balanceElement.textContent = data.newBalance + ' ‚ÇΩ';
                    
                    closeModal('balanceModal');
                    showNotification(`–ë–∞–ª–∞–Ω—Å —É—Å–ø–µ—à–Ω–æ –ø–æ–ø–æ–ª–Ω–µ–Ω –Ω–∞ ${amount} ‚ÇΩ!`, 'success');
                    

                    document.getElementById('balanceForm').reset();
                } else {
                    showNotification(data.message || '–û—à–∏–±–∫–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
            });
        }


        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }


        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }


        window.onclick = function(event) {
            const editModal = document.getElementById('editProfileModal');
            const balanceModal = document.getElementById('balanceModal');
            
            if (event.target === editModal) {
                closeModal('editProfileModal');
            }
            if (event.target === balanceModal) {
                closeModal('balanceModal');
            }
        }
    </script>
</body>
</html> 