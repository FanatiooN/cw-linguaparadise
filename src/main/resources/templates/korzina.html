<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–æ—Ä–∑–∏–Ω–∞ | LanguaParadise</title>
    <link href="/static/css/minimal.css" rel="stylesheet">
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <a href="/" class="logo">LanguaParadise</a>
                <nav class="nav">
                    <a href="/courses">–ö—É—Ä—Å—ã</a>
                    <a href="/person">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</a>
                    <a href="/korzina">–ö–æ—Ä–∑–∏–Ω–∞</a>
                    <a href="/logout">–í—ã—Ö–æ–¥</a>
                </nav>
            </div>
        </div>
    </header>

    <main>
        <div class="container">
            <h1>–ö–æ—Ä–∑–∏–Ω–∞</h1>
            <p class="text-center text-muted mb-4">
                –£–ø—Ä–∞–≤–ª—è–π—Ç–µ —Å–≤–æ–∏–º–∏ –∫—É—Ä—Å–∞–º–∏ –∏ –æ—Ñ–æ—Ä–º–ª—è–π—Ç–µ –∑–∞–∫–∞–∑
            </p>

            <!-- –ö–æ—Ä–∑–∏–Ω–∞ —Å –∫—É—Ä—Å–∞–º–∏ -->
            <div class="card">
                <div class="cart-header">
                    <h3>–í—ã–±—Ä–∞–Ω–Ω—ã–µ –∫—É—Ä—Å—ã</h3>
                    <button class="btn btn-secondary" onclick="clearCart()">–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É</button>
                </div>

                <div id="cartItems" class="cart-items">
                    <!-- –ö—É—Ä—Å—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ JavaScript -->
                </div>

                <!-- –ü—É—Å—Ç–∞—è –∫–æ—Ä–∑–∏–Ω–∞ -->
                <div id="emptyCart" class="text-center" style="display: none;">
                    <div class="empty-cart-icon">üõí</div>
                    <h3>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</h3>
                    <p class="text-muted mb-4">–î–æ–±–∞–≤—å—Ç–µ –∫—É—Ä—Å—ã –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞ –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞</p>
                    <a href="/courses" class="btn btn-primary">–ü–µ—Ä–µ–π—Ç–∏ –∫ –∫—É—Ä—Å–∞–º</a>
                </div>

                <!-- –ò—Ç–æ–≥–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                <div id="cartSummary" class="cart-summary" style="display: none;">
                    <div class="summary-row">
                        <span>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫—É—Ä—Å–æ–≤:</span>
                        <span id="totalItems">0</span>
                    </div>
                    <div class="summary-row">
                        <span>–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</span>
                        <span id="totalPrice">0‚ÇΩ</span>
                    </div>
                    <div class="summary-row balance-check" id="balanceCheck" style="display: none;">
                        <span>–í–∞—à –±–∞–ª–∞–Ω—Å:</span>
                        <span id="userBalance">0‚ÇΩ</span>
                        <button class="btn btn-sm btn-secondary" onclick="refreshBalance()" style="margin-left: 10px;">
                            üîÑ –û–±–Ω–æ–≤–∏—Ç—å
                        </button>
                    </div>
                    <div id="insufficientFunds" class="alert alert-warning" style="display: none;">
                        ‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ. –ü–æ–ø–æ–ª–Ω–∏—Ç–µ –±–∞–ª–∞–Ω—Å –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ.
                    </div>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
                <div id="cartActions" class="cart-actions" style="display: none;">
                    <button class="btn btn-primary" onclick="checkout()" id="checkoutBtn">
                        –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑
                    </button>
                    <a href="/courses" class="btn btn-secondary">
                        –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–∫—É–ø–∫–∏
                    </a>
                </div>
            </div>

            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ -->
            <div class="card mt-4">
                <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ</h3>
                <ul class="text-muted">
                    <li>–ü–æ—Å–ª–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ email-–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</li>
                    <li>–í –ø–∏—Å—å–º–µ –±—É–¥–µ—Ç —É–∫–∞–∑–∞–Ω —Å–ø–∏—Å–æ–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫—É—Ä—Å–æ–≤ –∏ –æ–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</li>
                    <li>–î–æ—Å—Ç—É–ø –∫ –∫—É—Ä—Å–∞–º –±—É–¥–µ—Ç –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤</li>
                    <li>–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –≤–æ–ø—Ä–æ—Å–æ–≤ –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –≤ —Å–ª—É–∂–±—É –ø–æ–¥–¥–µ—Ä–∂–∫–∏</li>
                </ul>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>–û –Ω–∞—Å</h3>
                    <p class="text-muted">
                        LanguaParadise ‚Äî —Ä–∞–∑—Ä—É—à–∞–µ–º —è–∑—ã–∫–æ–≤—ã–µ –±–∞—Ä—å–µ—Ä—ã —Å –∫–æ–º—Ñ–æ—Ä—Ç–æ–º!
                    </p>
                </div>
                <div class="footer-section">
                    <h3>–ù–∞–≤–∏–≥–∞—Ü–∏—è</h3>
                    <ul>
                        <li><a href="/courses">–ö—É—Ä—Å—ã</a></li>
                        <li><a href="/person">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</a></li>
                        <li><a href="/korzina">–ö–æ—Ä–∑–∏–Ω–∞</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>–ö–æ–Ω—Ç–∞–∫—Ç—ã</h3>
                    <ul>
                        <li>–ò–ö–ë–û-36-22</li>
                        <li>–ù–∞–∑–∏—Ä–æ–≤ –§. –§.</li>
                        <li><a href="mailto:nazirov.f.f@gmail.com">nazirov.f.f@gmail.com</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </footer>

    <script>

        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        

        let userBalance = 0;
        

        document.addEventListener('DOMContentLoaded', function() {

            getUserBalance();
            

            updateCartDisplay();
        });


        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                getUserBalance();
            }
        });


        window.addEventListener('focus', function() {
            getUserBalance();
        });


        function getUserBalance() {
            fetch('/api/user/balance', {
                method: 'GET',
                headers: {
                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                    'Pragma': 'no-cache',
                    'Expires': '0'
                }
            })
                .then(response => response.json())
                .then(data => {
                    userBalance = data.balance || 0;
                    document.getElementById('userBalance').textContent = userBalance + '‚ÇΩ';
                    updateCartDisplay();
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞:', error);
                    userBalance = 0;
                    document.getElementById('userBalance').textContent = '0‚ÇΩ';
                });
        }


        function refreshBalance() {
            showNotification('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞...', 'info');
            getUserBalance();
        }


        function removeFromCart(id) {
            cart = cart.filter(item => item.id !== id);
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartDisplay();
            showNotification('–ö—É—Ä—Å —É–¥–∞–ª–µ–Ω –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã', 'info');
        }


        function clearCart() {
            if (cart.length === 0) {
                showNotification('–ö–æ—Ä–∑–∏–Ω–∞ —É–∂–µ –ø—É—Å—Ç–∞', 'info');
                return;
            }
            
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É?')) {
                cart = [];
                localStorage.setItem('cart', JSON.stringify(cart));
                updateCartDisplay();
                showNotification('–ö–æ—Ä–∑–∏–Ω–∞ –æ—á–∏—â–µ–Ω–∞', 'info');
            }
        }


        function updateCartDisplay() {
            const cartItems = document.getElementById('cartItems');
            const emptyCart = document.getElementById('emptyCart');
            const cartSummary = document.getElementById('cartSummary');
            const cartActions = document.getElementById('cartActions');
            const balanceCheck = document.getElementById('balanceCheck');
            const insufficientFunds = document.getElementById('insufficientFunds');

            if (cart.length === 0) {
                cartItems.innerHTML = '';
                emptyCart.style.display = 'block';
                cartSummary.style.display = 'none';
                cartActions.style.display = 'none';
                return;
            }

            emptyCart.style.display = 'none';
            cartSummary.style.display = 'block';
            cartActions.style.display = 'block';


            cartItems.innerHTML = cart.map(course => `
                <div class="cart-item">
                    <div class="course-info">
                        <div class="course-avatar">
                            ${course.avatar ? 
                                `<img src="${course.avatar}" alt="–ê–≤–∞—Ç–∞—Ä –∫—É—Ä—Å–∞">` : 
                                '<div class="avatar-placeholder">üìö</div>'
                            }
                        </div>
                        <div class="course-details">
                            <h4>${course.name}</h4>
                            <p class="course-price">${course.price}‚ÇΩ</p>
                            <p class="course-description">${course.description}</p>
                        </div>
                    </div>
                    <button class="btn btn-danger btn-sm" onclick="removeFromCart(${course.id})">
                        –£–¥–∞–ª–∏—Ç—å
                    </button>
                </div>
            `).join('');


            const totalItems = cart.length;
            const totalPrice = cart.reduce((sum, course) => sum + course.price, 0);

            document.getElementById('totalItems').textContent = totalItems;
            document.getElementById('totalPrice').textContent = totalPrice + '‚ÇΩ';


            balanceCheck.style.display = 'block';
            const checkoutBtn = document.getElementById('checkoutBtn');
            
            if (totalPrice > userBalance) {
                insufficientFunds.style.display = 'block';
                checkoutBtn.disabled = true;
                checkoutBtn.textContent = '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤';
            } else {
                insufficientFunds.style.display = 'none';
                checkoutBtn.disabled = false;
                checkoutBtn.textContent = '–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑';
            }
        }


        function checkout() {
            if (cart.length === 0) {
                showNotification('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞', 'warning');
                return;
            }

            const totalPrice = cart.reduce((sum, course) => sum + course.price, 0);
            if (totalPrice > userBalance) {
                showNotification('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ', 'error');
                return;
            }


            const orderData = {
                courses: cart,
                totalCost: totalPrice
            };

            fetch('/api/orders/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(orderData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω!', 'success');

                    cart = [];
                    localStorage.setItem('cart', JSON.stringify(cart));
                    updateCartDisplay();
                    

                    userBalance = userBalance - totalPrice;
                    document.getElementById('userBalance').textContent = userBalance + '‚ÇΩ';
                    

                    setTimeout(() => {
                        window.location.href = '/person';
                    }, 2000);
                } else {
                    showNotification(data.message || '–û—à–∏–±–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
            });
        }


        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }
    </script>
</body>
</html> 